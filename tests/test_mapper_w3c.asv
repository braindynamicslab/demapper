% Setup base path
clear;
basefolder  = split(pwd, 'mappertoolbox-matlab');
basefolder  = [basefolder{1}, 'mappertoolbox-matlab'];
codefolder  = [basefolder,'/code'];
toolsfolder  = [basefolder,'/tests/tools'];
addpath(genpath(codefolder));
addpath(genpath(toolsfolder));

% Load Data
data_path = '/Users/dh/workspace/BDL/demapper/data/w3c_hightr2/SBJe2v0_bold.npy';

data = readNPY(data_path);
% data = read_1d(data_path);
data = zscore(data);

%% 

% Setup default mapper
opts = BDLMapperOpts(32, 20, 70);
% opts = NeuMapperOpts(32, 200, 35);
% opts = KeplerMapperOpts(20, 70, 'euclidean');
opts.low_mem = false;

% Run mapper
res = mapper(data, opts);

nodeSize = cell2mat(cellfun(@(x) size(x, 2), res.nodeMembers, 'UniformOutput', false));
nodeSize = normalize(nodeSize, 'range', [2, 10]);
avgNode = cellfun(@mean, res.nodeMembers);

g = graph(res.adjacencyMat);

plot(g, 'Layout', 'force', 'Usegravity', true, 'WeightEffect', 'inverse', ...
    'MarkerSize', nodeSize, 'NodeCData', avgNode);
colorbar
colormap parula

%% 

task_info_path = '/Users/dh/workspace/BDL/demapper/data/w3c_hightr2/task_info_e2v0.csv';
timing_table = read_task_file(task_info_path);
tasks = unique(timing_table).task_name;
ids = arrayfun(@(x) find(strcmp(tasks, x)), timing_table.task_name);
cmap = colormap("prism");

figure;
scatter(res.embed_X(, 'NodeCData', avgNode);

%% Helper functions
function timing_table = read_task_file(task_path)
timing_table = readtable(task_path, 'FileType', 'text', 'Delimiter', ',');
timing_table.task_name = string(timing_table.task_name);
end